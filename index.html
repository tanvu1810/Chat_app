<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Private Chat (ESM Server)</title>
    <style>
      body {
        margin: 0;
        font-family: system-ui, Arial;
        height: 100vh;
        display: flex;
      }
      #left {
        width: 280px;
        background: #2b0a3d;
        color: #fff;
        padding: 16px;
        box-sizing: border-box;
      }
      #right {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .user {
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        margin: 6px 0;
        background: rgba(255, 255, 255, 0.08);
      }
      .user.active {
        background: rgba(0, 140, 255, 0.35);
      }
      #top {
        padding: 12px 16px;
        border-bottom: 1px solid #ddd;
      }
      #chat {
        flex: 1;
        padding: 16px;
        overflow: auto;
      }
      .msg {
        margin: 8px 0;
      }
      .me {
        font-weight: 600;
      }
      #composer {
        display: flex;
        gap: 8px;
        padding: 12px 16px;
        border-top: 1px solid #ddd;
      }
      #input {
        flex: 1;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #ccc;
      }
      button {
        padding: 10px 14px;
      }
      #login {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        display: flex;
        align-items: flex-start;
        justify-content: center;
        padding-top: 80px;
      }
      #loginBox {
        background: #fff;
        padding: 16px;
        border-radius: 12px;
        width: 360px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
      }
      #name {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ccc;
        border-radius: 10px;
        box-sizing: border-box;
      }
      .hint {
        color: #666;
        font-size: 12px;
        margin-top: 8px;
      }
    </style>
  </head>

  <body>
    <!-- Login overlay -->
    <div id="login">
      <div id="loginBox">
        <div style="font-weight: 700; margin-bottom: 8px">Enter your name</div>
        <input id="name" placeholder="Your username..." />
        <div style="display: flex; gap: 8px; margin-top: 10px">
          <button id="joinBtn" type="button">Join</button>
          <button id="resetBtn" type="button">Reset</button>
        </div>
        <div class="hint">
          Username sẽ được lưu localStorage. Mở 2 tab để test 2 user.
        </div>
      </div>
    </div>

    <div id="left">
      <div id="meLine" style="font-weight: 700; margin-bottom: 12px">
        Not connected
      </div>
      <div id="users"></div>
      <div style="margin-top: 14px">
        <button id="dropBtn" type="button">Simulate drop</button>
        <div class="hint" style="color: #cfcfcf">
          Test recovery: đóng kết nối cấp thấp.
        </div>
      </div>
    </div>

    <div id="right">
      <div id="top">Select a user to chat</div>
      <div id="chat"></div>

      <div id="composer">
        <input id="input" placeholder="Your message..." />
        <button id="sendBtn" type="button">Send</button>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const loginEl = document.getElementById("login");
      const nameEl = document.getElementById("name");
      const joinBtn = document.getElementById("joinBtn");
      const resetBtn = document.getElementById("resetBtn");

      const meLine = document.getElementById("meLine");
      const usersEl = document.getElementById("users");
      const topEl = document.getElementById("top");
      const chatEl = document.getElementById("chat");
      const inputEl = document.getElementById("input");
      const sendBtn = document.getElementById("sendBtn");
      const dropBtn = document.getElementById("dropBtn");

      let socket = null;
      let username = localStorage.getItem("username") || "";
      let activeTo = "";
      const conversations = new Map(); // toUser -> [{from,to,content,ts}]

      function genUsername(raw) {
        const base = raw
          .trim()
          .toLowerCase()
          .replace(/\s+/g, "_")
          .replace(/[^a-z0-9_]/g, "");
        const suffix = Math.floor(1000 + Math.random() * 9000);
        return base ? `${base}_${suffix}` : `user_${suffix}`;
      }

      function renderUsers(list) {
        usersEl.innerHTML = "";
        list.forEach((u) => {
          const div = document.createElement("div");
          div.className = "user" + (u === activeTo ? " active" : "");
          div.textContent = u + (u === username ? " (yourself)" : "");
          div.onclick = () => {
            if (u === username) return;
            activeTo = u;
            topEl.textContent = `Chatting with ${u}`;
            renderUsers(list);
            renderChat();
          };
          usersEl.appendChild(div);
        });
      }

      function renderChat() {
        chatEl.innerHTML = "";
        if (!activeTo) return;
        const msgs = conversations.get(activeTo) || [];
        msgs.forEach((m) => {
          const div = document.createElement("div");
          div.className = "msg";
          const who = m.from === username ? "me" : m.from;
          div.innerHTML = `<span class="${
            m.from === username ? "me" : ""
          }">${who}:</span> ${m.content}`;
          chatEl.appendChild(div);
        });
        chatEl.scrollTop = chatEl.scrollHeight;
      }

      function addMsg(m) {
        const peer = m.from === username ? m.to : m.from; // conversation key
        if (!conversations.has(peer)) conversations.set(peer, []);
        conversations.get(peer).push(m);
        if (peer === activeTo) renderChat();
      }

      function connect() {
        socket = io({
          auth: { username },
        });

        socket.on("me", (info) => {
          meLine.textContent = `${info.username} | socketId=${info.socketId} | recovered=${info.recovered}`;
        });

        socket.on("users:list", (list) => {
          renderUsers(list);
        });

        socket.on("private:message", (m) => {
          addMsg(m);
        });

        socket.on("connect_error", (err) => {
          meLine.textContent = `connect_error: ${err.message}`;
        });
      }

      function showLogin() {
        loginEl.style.display = "flex";
        nameEl.value = username ? username : "";
      }
      function hideLogin() {
        loginEl.style.display = "none";
      }

      joinBtn.onclick = () => {
        const raw = nameEl.value;
        // Nếu user nhập "Alice" thì sinh username ổn định kiểu alice_1234
        username = genUsername(raw);
        localStorage.setItem("username", username);
        hideLogin();
        connect();
      };

      resetBtn.onclick = () => {
        localStorage.removeItem("username");
        username = "";
        location.reload();
      };

      sendBtn.onclick = () => {
        if (!socket || !socket.connected) return;
        if (!activeTo) return alert("Select a user first");
        const content = inputEl.value.trim();
        if (!content) return;

        socket
          .timeout(5000)
          .emit("private:message", { to: activeTo, content }, (err, res) => {
            if (err) console.warn("ACK timeout");
            else if (!res?.ok) alert(res.error);
          });

        inputEl.value = "";
      };

      dropBtn.onclick = () => {
        // simulate low-level drop to test recovery
        if (socket?.io?.engine) socket.io.engine.close();
      };

      // Start
      if (!username) showLogin();
      else {
        hideLogin();
        connect();
      }
    </script>
  </body>
</html>
