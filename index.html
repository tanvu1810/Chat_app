<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Private Chat (ESM Server)</title>
    <style>
      body {
        margin: 0;
        font-family: system-ui, Arial;
        height: 100vh;
        display: flex;
      }
      #left {
        width: 280px;
        background: #2b0a3d;
        color: #fff;
        padding: 16px;
        box-sizing: border-box;
      }
      #right {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .user {
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        margin: 6px 0;
        background: rgba(255, 255, 255, 0.08);
      }
      .user.active {
        background: rgba(0, 140, 255, 0.35);
      }
      #top {
        padding: 12px 16px;
        border-bottom: 1px solid #ddd;
      }
      #chat {
        flex: 1;
        padding: 16px;
        overflow: auto;
      }
      .msg {
        margin: 8px 0;
      }
      .me {
        font-weight: 600;
      }
      #composer {
        display: flex;
        gap: 8px;
        padding: 12px 16px;
        border-top: 1px solid #ddd;
      }
      #input {
        flex: 1;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #ccc;
      }
      button {
        padding: 10px 14px;
      }
      #login {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        display: flex;
        align-items: flex-start;
        justify-content: center;
        padding-top: 80px;
      }
      #loginBox {
        background: #fff;
        padding: 16px;
        border-radius: 12px;
        width: 360px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
      }
      #name {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ccc;
        border-radius: 10px;
        box-sizing: border-box;
      }
      .hint {
        color: #666;
        font-size: 12px;
        margin-top: 8px;
      }
    </style>
  </head>

  <body>
    <!-- Login overlay -->
    <div id="login">
      <div id="loginBox">
        <div style="font-weight: 700; margin-bottom: 8px">
          Nhập tên của bạn:
        </div>
        <input id="name" placeholder="Your username..." />
        <div style="display: flex; gap: 8px; margin-top: 10px">
          <button id="joinBtn" type="button">Vào</button>
          <button id="resetBtn" type="button">Xóa</button>
        </div>
      </div>
    </div>

    <div id="left">
      <div id="meLine" style="font-weight: 700; margin-bottom: 12px">
        Chưa kết nối
      </div>
      <div id="users"></div>
    </div>

    <div id="right">
      <div id="top">Chọn một người dùng để chat</div>
      <div id="chat"></div>

      <form id="composer">
        <input id="input" placeholder="Your message..." autocomplete="off" />
        <button id="sendBtn" type="submit">Gửi</button>
      </form>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const login = document.getElementById("login");
      const name = document.getElementById("name");
      const joinBtn = document.getElementById("joinBtn");

      const meLine = document.getElementById("meLine");
      const users = document.getElementById("users");
      const topEL = document.getElementById("top");
      const chat = document.getElementById("chat");

      const composerEl = document.getElementById("composer");
      const inputEl = document.getElementById("input");

      const MSG_KEY = "chat:conversations:v1";
      const USER_KEY = "chat:username:v1";

      function loadConversations() {
        try {
          const raw = sessionStorage.getItem(MSG_KEY);
          if (!raw) return new Map();
          return new Map(Object.entries(JSON.parse(raw)));
        } catch {
          return new Map();
        }
      }

      function saveConversations(conversations) {
        sessionStorage.setItem(
          MSG_KEY,
          JSON.stringify(Object.fromEntries(conversations))
        );
      }

      function genUsername(raw) {
        const base = raw.trim();
        return base || "user";
      }

      let socket = null;
      let username = sessionStorage.getItem(USER_KEY) || "";
      let activeTo = "";
      const conversations = loadConversations();

      function renderUsers(list) {
        users.innerHTML = "";
        list.forEach((u) => {
          const div = document.createElement("div");
          div.className = "user" + (u === activeTo ? " active" : "");
          div.textContent = u + (u === username ? " (yourself)" : "");
          div.onclick = () => {
            if (u === username) return;
            activeTo = u;
            topEL.textContent = `Chatting with ${u}`;
            renderUsers(list);
            renderChat();
          };
          users.appendChild(div);
        });
      }

      function renderChat() {
        chat.innerHTML = "";
        if (!activeTo) return;

        const msgs = conversations.get(activeTo) || [];
        msgs.forEach((m) => {
          const div = document.createElement("div");
          div.className = "msg";
          const who = m.from === username ? "me" : m.from;
          div.innerHTML = `<span class="${
            m.from === username ? "me" : ""
          }">${who}:</span> ${m.content}`;
          chat.appendChild(div);
        });
        chat.scrollTop = chat.scrollHeight;
      }

      function addMsg(m) {
        const peer = m.from === username ? m.to : m.from;
        if (!conversations.has(peer)) conversations.set(peer, []);
        conversations.get(peer).push(m);
        saveConversations(conversations);
        if (peer === activeTo) renderChat();
      }

      function connect() {
        socket = io({ auth: { username } });

        socket.on("connect", () => {
          meLine.textContent = `${username} | socketId=${socket.id}`;
        });

        socket.on("users:list", (list) => {
          renderUsers(list);
          if (activeTo && list.includes(activeTo)) {
            topEL.textContent = `Chatting with ${activeTo}`;
            renderChat();
          }
        });

        socket.on("private:message", (m) => addMsg(m));

        socket.on("connect_error", (err) => {
          meLine.textContent = `connect_error: ${err.message}`;
        });
      }

      function sendMessage() {
        if (!socket || !socket.connected) return;
        if (!activeTo) return alert("Select a user first");

        const content = inputEl.value.trim();
        if (!content) return;

        socket
          .timeout(5000)
          .emit("private:message", { to: activeTo, content }, (err, res) => {
            if (err) console.warn("ACK timeout");
            else if (!res?.ok) alert(res.error);
          });

        inputEl.value = "";
      }

      composerEl.addEventListener("submit", (e) => {
        e.preventDefault();
        sendMessage();
      });

      joinBtn.onclick = () => {
        username = genUsername(name.value);
        sessionStorage.setItem(USER_KEY, username);
        login.style.display = "none";
        connect();
      };

      name.addEventListener("keydown", (e) => {
        if (e.key === "Enter") joinBtn.click();
      });

      // Start
      if (username) {
        login.style.display = "none";
        connect();
      } else {
        login.style.display = "flex";
      }
    </script>
  </body>
</html>
